name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    name: dockerify
    runs-on: ubuntu-latest

    steps:
    - name: checkout repo
      uses: actions/checkout@v3
    
    - name: Build the backend Docker image
      working-directory: ./backend/
      run: docker build . --file ./backend/Dockerfile --tag mikkak/backend:latest
    
    - name: Build the frontent Docker image
      working-directory: ./frontend/
      run: docker build . --file ./frontend/Dockerfile --tag mikkak/frontend:latest
    
    - name: Push backend
      run: docker push mikkak/backend:latest
    
    - name: Push frontend
      run: docker push mikkak/frontend:latest
  
    - name: deploy on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
        port: 22
        script: |
          docker-compose down
          docker rmi mikkak/frontend --force
          docker rmi mikkak/backend --force
          docker pull mikkak/frontend:latest
          docker pull mikkak/backend:latest
          docker-compose up -d
        
